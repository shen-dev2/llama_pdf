{% extends "base.html" %}
{% block title %}Admin Dashboard - Enterprise{% endblock %}

{% block sidebar %}
<div class="sidebar">
  <h5 class="p-3">Admin Navigation</h5>
  <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-primary m-2 w-90">Dashboard</a>
  <a href="{{ url_for('view_sitemap') }}" class="btn btn-outline-info m-2 w-90">View Sitemap</a>
</div>
{% endblock %}

{% block content %}

<h2>Admin Dashboard</h2>

<div class="row">
  <div class="col-lg-4 border-end">
    <h4>Upload RFP Files</h4>
    <form method="POST" enctype="multipart/form-data" action="{{ url_for('upload_file') }}">
      <input class="form-control" type="file" name="file" accept=".pdf,.txt" required />
      <button type="submit" class="btn btn-primary mt-2">Upload</button>
    </form>

    <h5 class="mt-4">Uploaded Files</h5>
    <ul class="list-group">
      {% for f in filenames %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        {{ f }}
        <a href="{{ url_for('view_metadata', filename=f) }}" class="btn btn-sm btn-outline-secondary">View Metadata</a>
      </li>
      {% else %}
      <li class="list-group-item">No files uploaded</li>
      {% endfor %}
    </ul>
  </div>

  <div class="col-lg-8">
    <h4>Knowledge Graph</h4>
    <svg id="knowledgeGraph" width="100%" height="250" style="border:1px solid #ddd;"></svg>
    <button class="btn btn-sm btn-success mt-2" onclick="downloadGraphSVG()">Download Graph</button>

    <h4 class="mt-4">Ollama Model Summary</h4>
    <p><strong>Total Documents:</strong> {{ ollama_summary.total_docs }}</p>
    <p><strong>Documents:</strong> {{ ', '.join(ollama_summary.list) }}</p>
    <p><strong>Keywords:</strong> {{ ', '.join(ollama_summary.keywords) }}</p>
    <p><strong>Domains:</strong> {{ ', '.join(ollama_summary.domains) }}</p>
  </div>
</div>

<script>
  // Draw knowledge graph using simple svg circles and lines
  const nodes = {{ knowledge_graph.nodes|tojson }};
  const edges = {{ knowledge_graph.edges|tojson }};
  const svg = document.getElementById("knowledgeGraph");
  svg.innerHTML = '';

  const W = svg.clientWidth;
  const H = svg.clientHeight;
  // Simple circular layout
  const centerX = W / 2;
  const centerY = H / 2;
  const radius = Math.min(W,H)/3;

  // position nodes in circle
  nodes.forEach((node, idx) => {
    node.x = centerX + radius * Math.cos((2*Math.PI*idx)/nodes.length);
    node.y = centerY + radius * Math.sin((2*Math.PI*idx)/nodes.length);
  });

  // Draw edges as lines
  edges.forEach(e => {
    const fromNode = nodes.find(n => n.id === e.from);
    const toNode = nodes.find(n => n.id === e.to);
    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", fromNode.x);
    line.setAttribute("y1", fromNode.y);
    line.setAttribute("x2", toNode.x);
    line.setAttribute("y2", toNode.y);
    line.setAttribute("stroke", "#555");
    line.setAttribute("stroke-width", "2");
    svg.appendChild(line);
  });

  // Draw nodes
  nodes.forEach(node => {
    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    circle.setAttribute("cx", node.x);
    circle.setAttribute("cy", node.y);
    circle.setAttribute("r", 20);
    circle.setAttribute("fill", "#007bff");
    circle.setAttribute("stroke", "#004085");
    circle.setAttribute("stroke-width", "2");
    svg.appendChild(circle);

    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
    text.setAttribute("x", node.x);
    text.setAttribute("y", node.y + 5);
    text.setAttribute("font-size", "12px");
    text.setAttribute("font-weight", "bold");
    text.setAttribute("fill", "white");
    text.setAttribute("text-anchor", "middle");
    text.textContent = node.label;
    svg.appendChild(text);
  });

  function downloadGraphSVG() {
    let serializer = new XMLSerializer();
    let source = serializer.serializeToString(svg);
    let blob = new Blob([source], {type:"image/svg+xml;charset=utf-8"});
    let url = URL.createObjectURL(blob);
    let a = document.createElement("a");
    a.href = url;
    a.download = "knowledge_graph.svg";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
</script>

{% endblock %}
